# üîç An√°lise Detalhada - Novas Premissas e Impactos

**Data**: 14 de outubro de 2025  
**Objetivo**: Analisar novas premissas e propor melhorias no sistema

---

## üìã Premissas Analisadas

### 1. Limites de Tamanho do PDF

#### üîç Situa√ß√£o Atual

**PyMuPDF (pymupdf)**:
- ‚úÖ **Sem limite te√≥rico** de tamanho de arquivo
- ‚úÖ Processa PDFs de qualquer tamanho
- ‚úÖ Extra√ß√£o de texto √© r√°pida (~0.1s por p√°gina)
- ‚ö†Ô∏è Mem√≥ria RAM √© o √∫nico limitador pr√°tico

**Teste realizado**:
- PDF com 190 p√°ginas: ‚úÖ Extraiu texto com sucesso
- PDF com 52 p√°ginas: ‚úÖ Extraiu texto com sucesso
- Tempo m√©dio: ~1.5s por p√°gina de of√≠cio

**Limite REAL identificado**: 
- ‚ùå **GPT-4o-mini**: 128.000 tokens (~96.000 palavras)
- ‚ùå **Erro encontrado**: PDF com 190 p√°ginas = 135.987 tokens
- ‚úÖ **PyMuPDF**: Sem limite pr√°tico

**Conclus√£o**: O problema N√ÉO √© a extra√ß√£o do texto, √© o envio ao LLM!

---

### 2. Enviar Apenas P√°ginas Relevantes ao LLM

#### üéØ Proposta

**Ao inv√©s de**:
```python
# Enviar TODO o texto do PDF (pode ter 1000+ p√°ginas)
texto_completo = extrair_todo_pdf()
llm.processar(texto_completo)  # ‚ùå Pode exceder limite
```

**Fazer**:
```python
# Enviar APENAS p√°ginas relevantes
paginas_oficio = detectar_oficio_requisitorio()  # Ex: p√°ginas 15-17
paginas_anexo_ii = detectar_anexo_ii()           # Ex: p√°gina 17
paginas_processamento = detectar_processamento() # Ex: p√°gina 21

texto_relevante = extrair_paginas(paginas_oficio + paginas_anexo_ii + paginas_processamento)
llm.processar(texto_relevante)  # ‚úÖ Muito menor!
```

#### ‚úÖ Vantagens

1. **Redu√ß√£o dr√°stica de tokens**
   - PDF de 190 p√°ginas ‚Üí Enviar apenas 5-10 p√°ginas relevantes
   - 135.987 tokens ‚Üí ~5.000 tokens (redu√ß√£o de 96%)
   - ‚úÖ Sempre dentro do limite de 128K tokens

2. **Processamento mais r√°pido**
   - Menos texto = resposta mais r√°pida do LLM
   - Custo menor (paga por token)
   - Tempo m√©dio: 10-15s ‚Üí 3-5s

3. **Maior precis√£o**
   - LLM foca apenas no conte√∫do relevante
   - Menos "ru√≠do" de outras p√°ginas
   - Melhor extra√ß√£o de dados

#### üîß Implementa√ß√£o Necess√°ria

**J√° temos**:
- ‚úÖ `DetectorOficio`: Detecta p√°ginas do of√≠cio requisit√≥rio
- ‚úÖ `DetectorAnexoII`: Detecta p√°ginas do ANEXO II

**Precisamos adicionar**:
- üÜï `DetectorProcessamento`: Detectar p√°gina com "PROCESSAMENTO"
- üÜï `DetectorCPF`: Validar CPF do requerente na p√°gina
- üîÑ Modificar `ProcessadorOficio` para enviar apenas p√°ginas relevantes

---

### 3. Valida√ß√£o de CPF e M√∫ltiplos Processos

#### üîç Problema Identificado

**Cen√°rio**: PDF com m√∫ltiplos processos/pessoas
```
P√°gina 1-50:   Processo de Jo√£o (CPF: 123.456.789-01)
P√°gina 51-100: Processo de Maria (CPF: 987.654.321-09)  ‚Üê Queremos este!
P√°gina 101-150: Processo de Jos√© (CPF: 111.222.333-44)
```

**Desafio**: Como garantir que extra√≠mos o processo correto?

#### ‚úÖ Solu√ß√£o Proposta

**Estrat√©gia de Valida√ß√£o por CPF**:

1. **Extrair CPF da pasta**
   ```python
   # Pasta: data/consultas/98765432109/processo.pdf
   cpf_esperado = "98765432109"
   cpf_formatado = "987.654.321-09"
   ```

2. **Buscar CPF no PDF**
   ```python
   for pagina in pdf:
       texto = extrair_texto(pagina)
       if cpf_formatado in texto:
           # Encontrou a p√°gina com o CPF correto!
           pagina_inicio = pagina
           break
   ```

3. **Procurar "OF√çCIO REQUISIT√ìRIO" a partir desta p√°gina**
   ```python
   for pagina in range(pagina_inicio, len(pdf)):
       texto = extrair_texto(pagina)
       if "OF√çCIO REQUISIT√ìRIO" in texto:
           # Encontrou o of√≠cio do CPF correto!
           paginas_oficio = detectar_oficio_completo(pagina)
           break
   ```

4. **Extrair apenas este of√≠cio espec√≠fico**
   ```python
   texto_relevante = extrair_paginas(paginas_oficio)
   dados = llm.processar(texto_relevante)
   ```

#### üéØ Benef√≠cios

- ‚úÖ Garante que extra√≠mos o processo correto
- ‚úÖ Evita confus√£o com outros CPFs no mesmo PDF
- ‚úÖ Funciona com PDFs de qualquer tamanho
- ‚úÖ Reduz drasticamente o texto enviado ao LLM

---

### 4. N√∫mero de Ordem / N√∫mero do Precat√≥rio

#### üîç An√°lise das Imagens

**Imagem 1 (P√°gina 15)**: OF√çCIO REQUISIT√ìRIO
```
Processo n¬∫: 0035938-67.2018.8.26.0053/1142
Credor(s): Marcelo Pereira da Silva
Valor global: R$ 37.993,13
```

**Imagem 3 (P√°gina 17)**: ANEXO II
```
Nome: Marcelo Pereira da Silva
CPF: 116.713.778-77
Banco: 341 Ag√™ncia: 3740 Conta: 00000000000000001341-6
Valor requisitado: R$ 37.993,13
Principal/Indeniza√ß√£o: R$ 17.753,80
Juros Morat√≥rios: R$ 20.239,33
```

**Imagem 4 (P√°gina 21)**: PROCESSAMENTO
```
Processo DEPRE n¬∫: 0248001-50.2024.8.26.0500
N¬∫ de Ordem: 822/2026 (N√∫mero do Precat√≥rio)  ‚Üê NOVO CAMPO!
Data: 21/06/2024
Processo Origem n¬∫: 0035938-67.2018.8.26.0053/1142
Requerente: Marcelo Pereira da Silva
```

#### üÜï Novo Campo Identificado

**Campo**: `numero_ordem` ou `numero_precatorio`
- **Formato**: XXX/YYYY (ex: 822/2026)
- **Localiza√ß√£o**: P√°gina com t√≠tulo "PROCESSAMENTO"
- **Import√¢ncia**: ‚≠ê‚≠ê‚≠ê Alta (identificador √∫nico do precat√≥rio)

---

### 5. Campos M√≠nimos Obrigat√≥rios

#### üìä Prioriza√ß√£o de Campos

**CR√çTICOS (Obrigat√≥rios)**:
1. ‚úÖ `numero_ordem` / `numero_precatorio` (ex: 822/2026)
2. ‚úÖ `valor_principal_liquido` (ex: R$ 17.753,80)
3. ‚úÖ `valor_principal_bruto` (ex: R$ 37.993,13)
4. ‚úÖ `juros_moratorios` (ex: R$ 20.239,33)
5. ‚úÖ `valor_total_requisitado` (ex: R$ 37.993,13)

**IMPORTANTES (Desej√°veis)**:
- ‚úÖ `processo_origem` (j√° obrigat√≥rio)
- ‚úÖ `requerente_caps` (j√° obrigat√≥rio)
- ‚úÖ Dados banc√°rios (ANEXO II)
- ‚úÖ Contribui√ß√µes previdenci√°rias
- ‚úÖ Datas

**OPCIONAIS (Bom ter)**:
- Advogado
- Prefer√™ncias (idoso, doen√ßa grave, pcd)
- Outros detalhes

#### üîÑ Impacto no Schema Pydantic

**Mudan√ßas necess√°rias**:
```python
class OficioRequisitorio(BaseModel):
    # NOVOS CAMPOS OBRIGAT√ìRIOS
    numero_ordem: str = Field(
        ...,  # Obrigat√≥rio!
        description="N√∫mero de ordem/precat√≥rio (formato: XXX/YYYY)",
        pattern=r'^\d{1,5}/\d{4}$'
    )
    
    valor_principal_liquido: Decimal = Field(
        ...,  # Obrigat√≥rio! (era opcional)
        description="Valor principal l√≠quido",
        ge=0
    )
    
    valor_principal_bruto: Decimal = Field(
        ...,  # Obrigat√≥rio! (era opcional)
        description="Valor principal bruto",
        ge=0
    )
    
    juros_moratorios: Decimal = Field(
        ...,  # Obrigat√≥rio! (era opcional)
        description="Juros morat√≥rios",
        ge=0
    )
    
    valor_total_requisitado: Decimal = Field(
        ...,  # Obrigat√≥rio! (era opcional)
        description="Valor total requisitado",
        ge=0
    )
```

---

## üéØ Estrat√©gia de Processamento Otimizada

### Fluxo Proposto

```
1. ABRIR PDF
   ‚Üì
2. BUSCAR CPF FORMATADO (999.999.999-99)
   ‚Üì (encontrou na p√°gina X)
3. A PARTIR DA P√ÅGINA X, BUSCAR "OF√çCIO REQUISIT√ìRIO"
   ‚Üì (encontrou na p√°gina Y)
4. DETECTAR P√ÅGINAS DO OF√çCIO (Y at√© Y+N)
   ‚Üì
5. DETECTAR ANEXO II (geralmente Y+2 ou Y+3)
   ‚Üì
6. DETECTAR PROCESSAMENTO (buscar "PROCESSAMENTO" ap√≥s of√≠cio)
   ‚Üì
7. EXTRAIR TEXTO APENAS DESTAS P√ÅGINAS
   ‚Üì
8. ENVIAR AO LLM (muito menor!)
   ‚Üì
9. VALIDAR CAMPOS OBRIGAT√ìRIOS
   ‚Üì
10. SALVAR JSON/CSV
```

### Exemplo Pr√°tico

**PDF**: 200 p√°ginas  
**CPF**: 116.713.778-77

```python
# 1. Buscar CPF
pagina_cpf = buscar_cpf_formatado(pdf, "116.713.778-77")  # ‚Üí p√°gina 15

# 2. Buscar of√≠cio a partir desta p√°gina
pagina_oficio = buscar_oficio_requisitorio(pdf, inicio=15)  # ‚Üí p√°gina 15

# 3. Detectar p√°ginas relevantes
paginas_oficio = [15, 16]  # Of√≠cio completo
paginas_anexo = [17]       # ANEXO II
paginas_proc = [21]        # PROCESSAMENTO

# 4. Extrair apenas estas p√°ginas
texto_relevante = extrair_paginas(pdf, [15, 16, 17, 21])  # 4 p√°ginas!

# 5. Enviar ao LLM
dados = llm.processar(texto_relevante)  # ~3.000 tokens (vs 135.000!)

# 6. Validar
assert dados['numero_ordem']  # 822/2026
assert dados['valor_principal_liquido']  # 17753.80
assert dados['valor_total_requisitado']  # 37993.13
```

---

## üìä Impactos no Sistema Atual

### ‚úÖ O Que J√° Funciona

1. **DetectorOficio**: Detecta p√°ginas do of√≠cio
2. **DetectorAnexoII**: Detecta p√°ginas do ANEXO II
3. **Schema Pydantic**: Valida dados extra√≠dos
4. **Normaliza√ß√£o**: Dados banc√°rios aninhados ‚Üí campos diretos
5. **CSV detalhado**: Relat√≥rios com anomalias

### üîÑ O Que Precisa Mudar

1. **Adicionar DetectorProcessamento**
   - Buscar p√°gina com "PROCESSAMENTO"
   - Extrair n√∫mero de ordem/precat√≥rio

2. **Adicionar DetectorCPF**
   - Buscar CPF formatado no PDF
   - Validar que estamos no processo correto

3. **Modificar ProcessadorOficio**
   - Enviar apenas p√°ginas relevantes ao LLM
   - N√£o enviar PDF inteiro

4. **Atualizar Schema Pydantic**
   - Adicionar `numero_ordem` (obrigat√≥rio)
   - Tornar campos financeiros obrigat√≥rios

5. **Atualizar Prompt do LLM**
   - Solicitar explicitamente n√∫mero de ordem
   - Enfatizar campos financeiros obrigat√≥rios

### üÜï O Que Vamos Resolver

1. **‚úÖ PDFs muito grandes**
   - Antes: 190 p√°ginas = 135K tokens ‚ùå
   - Depois: 5-10 p√°ginas = 5K tokens ‚úÖ

2. **‚úÖ M√∫ltiplos processos no mesmo PDF**
   - Antes: Confus√£o entre CPFs ‚ùå
   - Depois: Valida√ß√£o por CPF ‚úÖ

3. **‚úÖ Campos financeiros ausentes**
   - Antes: Opcionais, frequentemente vazios ‚ùå
   - Depois: Obrigat√≥rios, sempre preenchidos ‚úÖ

4. **‚úÖ N√∫mero de ordem ausente**
   - Antes: Campo n√£o existia ‚ùå
   - Depois: Campo obrigat√≥rio extra√≠do ‚úÖ

5. **‚úÖ Custo e velocidade**
   - Antes: ~$0.0009/doc, ~40s/doc ‚ùå
   - Depois: ~$0.0003/doc, ~10s/doc ‚úÖ

---

## üîß Implementa√ß√£o Proposta

### Fase 1: Detectores (1-2 dias)

1. **DetectorCPF**
   ```python
   class DetectorCPF:
       def buscar_cpf(self, pdf_path: str, cpf: str) -> int:
           """Retorna n√∫mero da p√°gina onde CPF foi encontrado"""
   ```

2. **DetectorProcessamento**
   ```python
   class DetectorProcessamento:
       def detectar_processamento(self, pdf_path: str, inicio: int) -> Tuple[int, str]:
           """Retorna p√°gina e texto do PROCESSAMENTO"""
   ```

3. **Modificar DetectorOficio**
   ```python
   def detectar_oficio_a_partir_de(self, pdf_path: str, pagina_inicio: int):
       """Detecta of√≠cio a partir de uma p√°gina espec√≠fica"""
   ```

### Fase 2: Processador (1 dia)

1. **Modificar ProcessadorOficio.processar_arquivo()**
   ```python
   def processar_arquivo(self, pdf_path: str) -> Optional[OficioCompleto]:
       # 1. Extrair CPF da pasta
       cpf = extrair_cpf_pasta(pdf_path)
       
       # 2. Buscar CPF no PDF
       pagina_cpf = detector_cpf.buscar_cpf(pdf_path, cpf)
       
       # 3. Detectar of√≠cio a partir desta p√°gina
       paginas_oficio = detector.detectar_oficio_a_partir_de(pdf_path, pagina_cpf)
       
       # 4. Detectar ANEXO II
       paginas_anexo = detector_anexo.detectar_anexo_ii(pdf_path, paginas_oficio)
       
       # 5. Detectar PROCESSAMENTO
       pagina_proc = detector_proc.detectar_processamento(pdf_path, paginas_oficio[-1])
       
       # 6. Extrair APENAS estas p√°ginas
       paginas_relevantes = paginas_oficio + paginas_anexo + [pagina_proc]
       texto_relevante = extrair_paginas(pdf_path, paginas_relevantes)
       
       # 7. Enviar ao LLM (muito menor!)
       dados = self._extrair_dados_llm(texto_relevante)
   ```

### Fase 3: Schema e Valida√ß√£o (1 dia)

1. **Atualizar OficioRequisitorio**
   - Adicionar `numero_ordem` (obrigat√≥rio)
   - Tornar campos financeiros obrigat√≥rios

2. **Atualizar Prompt do LLM**
   - Solicitar n√∫mero de ordem
   - Enfatizar campos financeiros

3. **Atualizar CSV**
   - Adicionar coluna `numero_ordem`

### Fase 4: Testes (1-2 dias)

1. **Testar com PDFs problem√°ticos**
   - PDF de 190 p√°ginas
   - PDF com m√∫ltiplos CPFs
   - PDF sem ANEXO II

2. **Validar campos obrigat√≥rios**
   - Garantir que todos s√£o extra√≠dos

3. **Medir melhorias**
   - Tempo de processamento
   - Custo por documento
   - Taxa de sucesso

---

## üìà Benef√≠cios Esperados

### Quantitativos

| M√©trica | Antes | Depois | Melhoria |
|---------|-------|--------|----------|
| **Tokens/doc** | ~100K | ~5K | **95% redu√ß√£o** |
| **Custo/doc** | $0.0009 | $0.0003 | **67% redu√ß√£o** |
| **Tempo/doc** | 40s | 10s | **75% redu√ß√£o** |
| **Taxa sucesso** | 80% | 95%+ | **+15%** |
| **PDFs grandes** | ‚ùå Falha | ‚úÖ Sucesso | **100% melhoria** |

### Qualitativos

- ‚úÖ **Maior precis√£o**: LLM foca apenas no relevante
- ‚úÖ **Menos erros**: Valida√ß√£o por CPF evita confus√£o
- ‚úÖ **Campos completos**: Obrigatoriedade garante dados
- ‚úÖ **Escalabilidade**: Funciona com PDFs de qualquer tamanho
- ‚úÖ **Manutenibilidade**: C√≥digo mais modular e test√°vel

---

## üéØ Pr√≥ximos Passos Recomendados

### Imediato (Hoje)

1. ‚úÖ **Aprovar estrat√©gia** proposta
2. ‚úÖ **Priorizar implementa√ß√£o** (Fases 1-4)
3. ‚úÖ **Definir PDFs de teste** (incluir casos extremos)

### Curto Prazo (Esta Semana)

1. üî® **Implementar DetectorCPF**
2. üî® **Implementar DetectorProcessamento**
3. üî® **Modificar ProcessadorOficio**
4. üß™ **Testar com 5-10 PDFs**

### M√©dio Prazo (Pr√≥xima Semana)

1. üìä **Processar lote de 50 PDFs**
2. üìà **Analisar m√©tricas de melhoria**
3. üîÑ **Ajustar conforme necess√°rio**
4. ‚úÖ **Aprovar para produ√ß√£o**

---

## ‚ùì Perguntas para Decis√£o

1. **Campos obrigat√≥rios**: Concordam com a lista de campos cr√≠ticos?
2. **Valida√ß√£o CPF**: Devemos bloquear se CPF n√£o for encontrado?
3. **N√∫mero de ordem**: Deve ser obrigat√≥rio ou opcional?
4. **PDFs sem PROCESSAMENTO**: Como tratar? (alguns podem n√£o ter)
5. **Prioridade**: Come√ßamos pela Fase 1 (detectores)?

---

**Status**: üü° Aguardando aprova√ß√£o para implementa√ß√£o  
**Estimativa**: 4-6 dias de desenvolvimento + testes  
**Impacto**: üü¢ Alto (resolve problemas cr√≠ticos)  
**Risco**: üü¢ Baixo (mudan√ßas incrementais)
